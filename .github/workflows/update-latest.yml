name: Update Latest Versions

on:
  schedule:
    # 毎週火曜 9:00 JST = 0:00 UTC
    - cron: '0 0 * * 2'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Install internal CA
        run: |
          set -euo pipefail
          echo "${{ secrets.CA_CERT_B64 }}" | base64 -d \
            | sudo tee /usr/local/share/ca-certificates/org-internal-ca.crt >/dev/null
          sudo update-ca-certificates --fresh
          git config --global http.sslCAInfo /etc/ssl/certs/ca-certificates.crt

      - name: Checkout repository
        run: |
          REPO_URL="${{ gitea.server_url }}/${{ gitea.repository }}.git"
          AUTH_URL=$(echo "$REPO_URL" | sed "s|https://|https://${{ secrets.PROXY_USER }}:${{ secrets.PROXY_PASS }}@|")
          git clone --depth 1 --branch "${{ gitea.ref_name }}" "$AUTH_URL" .
          git remote set-url origin "$REPO_URL"
          git config user.name "gitea-actions[bot]"
          git config user.email "gitea-actions[bot]@users.noreply.gitea.com"
          git config credential.helper store
          echo "https://${{ secrets.PROXY_USER }}:${{ secrets.PROXY_PASS }}@${{ secrets.REPO_HOST }}" > ~/.git-credentials

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
        env:
          HTTP_PROXY: ${{ secrets.PROXY_URL }}
          HTTPS_PROXY: ${{ secrets.PROXY_URL }}
          http_proxy: ${{ secrets.PROXY_URL }}
          https_proxy: ${{ secrets.PROXY_URL }}

      - name: Create version.csv if not exists
        run: |
          if [ ! -f version.csv ]; then
            echo '"formal_name","name","desired_version","latest_version"' > version.csv
          fi

      - name: Run update script
        env:
          GITHUB_TOKEN: ${{ secrets.GH_API_TOKEN }}
          HTTP_PROXY: ${{ secrets.PROXY_URL }}
          HTTPS_PROXY: ${{ secrets.PROXY_URL }}
          http_proxy: ${{ secrets.PROXY_URL }}
          https_proxy: ${{ secrets.PROXY_URL }}
        run: |
          python automation/tools_update_latest.py \
            --csv version.csv \
            --out version.csv \
            -v

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet version.csv; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git checkout -b latest
          git add version.csv
          git commit -m "$(date +%Y-%m-%d)"
          git push --force origin latest
