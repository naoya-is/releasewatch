name: Apply Checked Updates

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to apply'
        required: true
        type: string

jobs:
  apply:
    runs-on: ubuntu-latest
    # PRコメントで /apply の場合、または手動実行の場合
    if: >
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/apply')) ||
      github.event_name == 'workflow_dispatch'
    env:
      PR_NUMBER: ${{ github.event.issue.number || inputs.pr_number }}
    steps:
      - name: Install internal CA
        run: |
          set -euo pipefail
          echo "${{ secrets.CA_CERT_B64 }}" | base64 -d \
            | sudo tee /usr/local/share/ca-certificates/org-internal-ca.crt >/dev/null
          sudo update-ca-certificates --fresh
          git config --global http.sslCAInfo /etc/ssl/certs/ca-certificates.crt

      - name: Checkout repository
        run: |
          REPO_URL="${{ gitea.server_url }}/${{ gitea.repository }}.git"
          AUTH_URL=$(echo "$REPO_URL" | sed "s|https://|https://${{ secrets.PROXY_USER }}:${{ secrets.PROXY_PASS }}@|")
          git clone --depth 1 --branch "${{ gitea.ref_name }}" "$AUTH_URL" .
          git remote set-url origin "$REPO_URL"
          git config user.name "gitea-actions[bot]"
          git config user.email "gitea-actions[bot]@users.noreply.gitea.com"
          git config credential.helper store
          echo "https://${{ secrets.PROXY_USER }}:${{ secrets.PROXY_PASS }}@${{ secrets.REPO_HOST }}" > ~/.git-credentials

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
        env:
          HTTP_PROXY: ${{ secrets.PROXY_URL }}
          HTTPS_PROXY: ${{ secrets.PROXY_URL }}
          http_proxy: ${{ secrets.PROXY_URL }}
          https_proxy: ${{ secrets.PROXY_URL }}

      - name: Get PR body
        env:
          HTTP_PROXY: ${{ secrets.PROXY_URL }}
          HTTPS_PROXY: ${{ secrets.PROXY_URL }}
        run: |
          API_URL="${{ gitea.server_url }}/api/v1/repos/${{ gitea.repository }}/pulls/${{ env.PR_NUMBER }}"
          curl -s "$API_URL" \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            | jq -r '.body' > /tmp/pr_body.txt
          echo "PR body:"
          cat /tmp/pr_body.txt

      - name: Apply checked items
        run: |
          python automation/tools_apply_checked.py \
            --csv version.csv \
            --out version.csv \
            --pr-body /tmp/pr_body.txt \
            -v

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet version.csv; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.changes.outputs.changed == 'true'
        run: |
          git add version.csv
          git commit -m "chore: apply selected updates from PR #${{ env.PR_NUMBER }}"
          git push origin HEAD

      - name: Close PR
        if: steps.changes.outputs.changed == 'true'
        env:
          HTTP_PROXY: ${{ secrets.PROXY_URL }}
          HTTPS_PROXY: ${{ secrets.PROXY_URL }}
        run: |
          API_URL="${{ gitea.server_url }}/api/v1/repos/${{ gitea.repository }}/pulls/${{ env.PR_NUMBER }}"

          # Add comment
          COMMENT_URL="${{ gitea.server_url }}/api/v1/repos/${{ gitea.repository }}/issues/${{ env.PR_NUMBER }}/comments"
          curl -X POST "$COMMENT_URL" \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"body": "✅ Applied selected updates."}'

          # Close PR
          curl -X PATCH "$API_URL" \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"state": "closed"}'
